# 변경 가능성을 최소화하라.
불변 클래스는 인스턴스의 내부 값을 수정할 수 없는 클래스이다. <br>
<br>

## 📌 클래스를 불변으로 만들기 위한 다섯 가지 규칙
1️. 객체의 상태를 변경하는 메서드를 제공하지 않는다. 
2️. 클래스를 확장할 수 없도록 한다. 
3️. 모든 필드를 final로 선언한다. 
4️. 모든 필드를 private로 선언한다. 
5️. 자신 외에는 내부의 가변 컴포넌트에 접근할 수 없도록 한다. 

<br>

## 📌 동기화
- 불변 객체는 근본적으로 스레드 안전하여 따로 동기화할 필요가 없다.
    - 여러 스레드가 동시에 사용해도 훼손되지 않는다.
    - 불변 객체에는 어떤 스레드도 다른 스레드에 영향을 줄 수 엇으니 안심하고 공유할 수 있다.
- 불변 클래스라면 한 번 만든 인스턴스를 최대한 재활용하기를 권한다.
    - 가장 쉬운 재활용 방법은 자주 쓰이는 값을 상수로 제공하는 것이다.
- 불변 클래스는 자주 사용되는 인스턴스를 캐싱 해 같은 인스턴스를 중복 생성하지 않게 해주는 정적 팩터리를 제공할 수 있다.
    - 정적 팩터리를 사용하면 여러 클라이언트가 인스턴스를 고유하여 메모리 사용량과 가비지 컬렉션 비용이 줄어든다.
- 불변 객체를 공유할 수 있다는 건 방어적 복사도 필요 없다는 결론으로 이어진다
    - 어차피 불변 객체이니 복사해 봐야 원본과 똑같은 복사 자체가 의미가 없다. 그렇기에 clone 메서드나 복사 생성자를 제공하지 않는 게 좋다.
- 불변 객체는 자유롭게 공유할 수 있음은 물론, 불변 객체끼리는 내부 데이터를 공유할 수 있다.
    - 객체를 만들 때 다른 불변 객체들을 구성요소로 사용하면 이점이 많다.
    - 값이 바뀌지 않는 구성요소들로 이뤄진 객체라면 구조가 복잡해도 불변식을 유지하기 훨씬 수월하기 떄문이다.
- 불변 객체는 그 자체로 실패 원자성을 제공한다.
    - 상태가 변하지 않으니 불일치 상태에 빠질 가능성이 없다.
    - 실패 원자성이란 메서드에서 예외가 발생한 후에도 그 객체는 여전히 유효한 상태여야 한다는 성질이다.

<br>

## 📌 단점
- 값이 다르면 반드시 독립된 객체로 만들어야 한다는 것이다.
    - 값의 가짓수가 많다면 이들을 모두 만드는 데 큰 비용을 치러야 한다.
- 백만 비트짜리 BigInteger에서 비트 하나를 바꿔야 한다면 아래 코드와 같다.

```java
BigInteger moby = ...;
moby = moby.flipBit(0);
```
<br>

위 코드 문제를 해결하려면 `다단계 연산을 예측해서 기본 기능으로 제공하는 방법` 이 있다. <br>

<br>

## 📌 불변 클래스 설계 방법
클래스가 불변임을 보장하려면 자신을 상속하지 못하게 해야 한다. <br>
- 가장 쉬운 방법은 final 클래스이다.
- 다른 방법으로는 모든 생성자를 private 혹은, package-private로 만들고 public 정적 팩터리를 제공하는 방법이다.

```java
public class Complex{
    private final double re;
    private final double im;

    private Complex(double re, double im){
        this.re = re;
        this.im = iml
    }

    public static Complex valueOf(double re,double im){
        return new Complex(re,im);
    }
```

<br>

## ⭐️ 최종 정리
- Getter가 있다고 해서 무조건 세터를 만들지는 말자.
  - 클래스는 꼭 필요한 경우가 아니면 불변이어야 한다.
- 단순한 값 객체는 항상 불변으로 만들자.
- 모든 클래스를 불변으로 만들 수는 없다.
  - 불변으로 만들 수 없는 클래스라도 변경할 수 있는 부분을 최소한으로 줄이자.
  - 객체가 가질 수 있는 상태의 수를 줄이면 객체를 예측하기 쉬워지고 오류가 생길 가능성이 줄어든다.
  - 변경이 필요한 거 말고는 final로 하자.
- 다른 합당한 이유가 없다면 모든 필드는 private final 이어야 한다.
- 생성자는 불변식 설정이 모두 완료된, 초기화가 완벽히 끝난 상태의 객체를 생성해야 한다.
  - 확실한 이유가 없다면 생성자와 정적 팩터리 외에는 그 어떤 초기화 메서드도 public으로 제공해서는 안 된다.
  - 객체를 재활용할 목적으로 상태를 다시 초기화하는 메서드도 안된다.
