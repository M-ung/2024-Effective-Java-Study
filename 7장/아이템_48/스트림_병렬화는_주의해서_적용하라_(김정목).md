# 스트림 병렬화는 주의해서 적용하라.

## 📌 동시성 프로그래밍의 역사
1. 릴리스
스레드, 동기화, wait/notify를 지원했다. <br>
>`wait` : 갖고 있던 고유 락을 해제하고, 스레드를 잠들게 한다. <br>
`notify` :잠들어 있던 스레드 중 임의로 하나를 골라 깨운다. <br>

2. 자바 5 이후
동시성 컬렉션인 `java.util.concurrent` 라이브러리와 실행자(Executor) 프레임워크 지원했다.

4. 자바 7 이후
고성능 병렬 분해 프레임워크인 포크-조인(fork-join) 패키지를 추가했다.

6. 자바 8 이후
`parallel` 메서드만 한 번 호출하면 파이프라인을 병렬 실행할 수 있는 스트림을 지원했다. <br>

이처럼 동시성 프로그램을 작성하기 점점 쉬워지고 있지만, 동시성 프로그래밍을 할때는 항상 `안전성`과 `응답 가능` 상태를 유지 해야 하는 것에 주의해야 한다.

## 📌 동시성 프로그래밍 주의점
1. 스트림 병렬화를 사용하면 안되는 경우
```java
public class ParallelMersennePrimes {
    public static void main(String[] args) {
        primes().map(p -> TWO.pow(p.intValueExact()).subtract(ONE))
                .parallel() // 스트림 병렬화
                .filter(mersenne -> mersenne.isProbablePrime(50))
                .limit(20)
                .forEach(System.out::println);
    }

    static Stream<BigInteger> primes() {
        return Stream.iterate(TWO, BigInteger::nextProbablePrime);
    }
}
```

속도를 높히고 싶어 `parallel()` 을 호출을 한다면, 안타깝게도 이 프로그램은 아무것도 출력하지 못하면서 CPU를 90%나 잡아먹는 상태가 무한히 계속된다. <br>
➡️ 이 이유는 스트림 라이브러리가 이 파이프라인을 병렬화하는 방법을 찾아내지 못했기 때문이다. <br>
➡️ 환경이 아무리 좋더라도 데이터 소스가 `Stream.iterate` 거나 중간 연산으로 `limit` 를 쓰면 파이프라인 병렬화로는 성능 개선을 기대할 수 없다. <br>

## 📌 스트림 병렬화는 어떤 경우 사용해야 하나?
대체로 스트림의 소스가 `ArrayList` , `HashMap`, `HashSet` , `ConcurrentHashMap` 의 인스턴스거나 배열, `int` 범위, `long` 범위일 때 병렬화의 효과가 가장 좋다. <br>

해당 자료구조들은 아래와 같은 두 가지 공통점을 지닌다. <br>

1. 정확성
모두 데이터를 원하는 크기로 정확하고 손쉽게 나눌 수 있어 다수의 스레드에 일을 분배하기에 좋다. 나누는 작업은 `Spliterator` 를 통해 이루어지며, `Iterable` 과 `Stream` 에서 얻을 수 있다.

2. 참조 지역성
참조 지역성은, 다음과 같이 세가지로 나누어진다.
> 1️⃣ 시간 지역성 : 최근에 참조된 주소는 빠른 시간 내에 다시 참조되는 특성 <br>
2️⃣ 공간 지역성 : 참조된 주소와 인접한 주소의 내용이 다시 참조되는 특성 <br>
3️⃣ 순차 지역성 : 데이터가 순차적으로 엑세스 되는 특성(공간 지역성) <br>

```
참조 지역성은, 요청할 데이터를 캐시 메모리에서 찾을 확률인 Cache Hit Rate과도 비례한다.
참조 지역성이 높으면 캐시에서 데이터를 바로 찾을 수 있으므로 속도가 빨라지지만, 낮다면 주 메모리에서 캐시로 다시 로드하는 과정이 필요하기 때문에 성능이 낮아진다. 
기본 타입의 배열과 같은 경우, 데이터 자체가 메모리에 연속해서 저장되기 때문에, 참조 지역성 중에서도 공간 지역성이 좋아 Cache Hit Rate이 가장 높다.
```

## 📌 종단 연산과 병렬화
종단 연산에서 수행하는 작업량이 파이프라인 전체 작업에서 상당 비중을 차지하면서 순차적인 연산이라면, 파이프라인 병렬 수행의 효과가 떨어진다. <br>
1. 적합한 종단 연산
>1. `reduce`
>2. `anyMatch` , `allMatch` , `noneMatch`

2. 나쁜 종단 연산
`collect` 와 같이 컬렉션들을 합치는 부담이 큰 메서드는 병렬화에 적합하지 않다.

## ⭐️ 핵심 정리
```
계산도 올바로 수행하고 성능도 발라질 거라는 확신 없이는 스트림 파이프라인 병렬화느 시도조차 하지 말아라.
스트림을 잘못 병렬화하면 프로그램을 오동작하게 하거나 성능을 급격히 떨어뜨린다.
그래서 계산도 정확하고 성농도 좋아졌음이 확실해졌을 때 ,오직 그럴 때만 병렬화 버전 코드를 운영 코드에 반영하라.
```
